name: Build workspace
description: Build workspace

inputs:
  docker_image:
    description: Docker image
    required: true
    default: kmake-image:latest
  workspace_path:
    description: Workspace path
    required: true

outputs:
  kernel_version:
    description: Kernel version built
    value: ${{ steps.get_version.outputs.kernel_version }}

runs:
  using: "composite"
  steps:
    - name: Make
      shell: bash
      run: |
        cd ${{ inputs.workspace_path }}
        mkdir -p ../kobj
        env -u KCONFIG_CONFIG ./scripts/kconfig/merge_config.sh -m -O ../kobj arch/arm64/configs/defconfig arch/arm64/configs/prune.config arch/arm64/configs/qcom.config kernel/configs/debug.config
        docker run -i --rm \
        --user $(id -u):$(id -g) \
        --workdir="$PWD" \
        -v "$(dirname $PWD)":"$(dirname $PWD)" \
        ${{ inputs.docker_image }} bash -c "
          make O=../kobj olddefconfig
          make O=../kobj -j$(nproc)
          make O=../kobj -j$(nproc) dir-pkg INSTALL_MOD_STRIP=1
        "

    - name: Get Kernel Version
      id: get_version
      shell: bash
      run: |
        cd ${{ inputs.workspace_path }}
        version=$(make kernelversion)
        echo "Kernel Version : $version"
        echo "kernel_version=$version" >> $GITHUB_OUTPUT
